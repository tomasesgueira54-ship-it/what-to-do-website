{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/EMPRESA/what-to-do-website/app/api/events/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\nimport { Event, MusicGenre, EventCategory } from \"@/data/types\";\r\n\r\nexport const dynamic = \"force-static\";\r\nexport const revalidate = 3600; // 1 hour\r\n\r\n/**\r\n * GET /api/events\r\n * Fetch and filter events with optional query parameters\r\n *\r\n * Query Parameters:\r\n * - search: string (searches title, description, location)\r\n * - category: string (filters by category)\r\n * - location: string (filters by location)\r\n * - sort: 'date' | 'title' | 'price' (default: 'date')\r\n * - limit: number (default: 250)\r\n *\r\n * Example:\r\n * /api/events?search=fado&category=Música&sort=date&limit=20\r\n */\r\nexport async function GET(request: NextRequest) {\r\n    try {\r\n        const filePath = path.join(process.cwd(), \"data\", \"events.json\");\r\n        const fileContent = fs.readFileSync(filePath, \"utf-8\");\r\n        const rawEvents: Event[] = JSON.parse(fileContent);\r\n\r\n        const searchParams = request.nextUrl.searchParams;\r\n        const search = searchParams.get(\"search\")?.toLowerCase() || \"\";\r\n        const category = searchParams.get(\"category\") || \"\";\r\n        const genre = searchParams.get(\"genre\") || \"\";\r\n        const location = searchParams.get(\"location\") || \"\";\r\n        const sort = searchParams.get(\"sort\") || \"date\";\r\n        const onlyFree = searchParams.get(\"free\") === \"true\";\r\n        const minPrice = parseFloat(searchParams.get(\"minPrice\") || \"0\");\r\n        const maxPrice = parseFloat(searchParams.get(\"maxPrice\") || \"\" + Infinity);\r\n        const includePast = searchParams.get(\"includePast\") === \"true\";\r\n        const limit = Math.min(parseInt(searchParams.get(\"limit\") || \"250\"), 250);\r\n\r\n        // Normalize + dedupe first\r\n        const deduped = dedupeEvents(rawEvents)\r\n            .filter((event) => (includePast ? true : isUpcoming(event)));\r\n\r\n        let filtered = deduped.filter((event) => {\r\n            const priceValue = normalizePrice(event.price).value;\r\n            const derivedCategory = event.category || detectCategory(event);\r\n            const derivedGenre = event.musicGenre || detectMusicGenre(event, derivedCategory);\r\n\r\n            if (search) {\r\n                const searchableText = `${event.title} ${event.description || \"\"} ${event.location || \"\"}`.toLowerCase();\r\n                if (!searchableText.includes(search)) return false;\r\n            }\r\n\r\n            if (category && derivedCategory !== category) return false;\r\n            if (genre && derivedGenre !== genre) return false;\r\n            if (location && !event.location?.toLowerCase().includes(location.toLowerCase())) return false;\r\n\r\n            if (onlyFree && priceValue !== 0) return false;\r\n            if (priceValue < minPrice) return false;\r\n            if (priceValue > maxPrice) return false;\r\n\r\n            return true;\r\n        });\r\n\r\n        filtered.sort((a, b): number => {\r\n            switch (sort) {\r\n                case \"title\":\r\n                    return a.title.localeCompare(b.title);\r\n                case \"price\": {\r\n                    const priceA = normalizePrice(a.price).value;\r\n                    const priceB = normalizePrice(b.price).value;\r\n                    return priceA - priceB;\r\n                }\r\n                case \"date\":\r\n                default:\r\n                    return new Date(a.date).getTime() - new Date(b.date).getTime();\r\n            }\r\n        });\r\n\r\n        filtered = filtered.slice(0, limit);\r\n\r\n        return NextResponse.json(filtered, {\r\n            headers: {\r\n                \"Cache-Control\": \"public, s-maxage=3600, stale-while-revalidate=86400\",\r\n            },\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Error fetching events:\", error);\r\n        return NextResponse.json({ error: \"Failed to fetch events\" }, { status: 500 });\r\n    }\r\n}\r\n\r\n/**\r\n * Extract numeric price from price string\r\n * Examples: \"Free\" → 0, \"€10-15\" → 10, \"Check site\" → Infinity\r\n */\r\nfunction normalizePrice(price?: string): { value: number; label: string } {\r\n    if (!price) return { value: Infinity, label: \"Preço indisponível\" };\r\n\r\n    const lower = price.toLowerCase();\r\n    if (lower.includes(\"grátis\") || lower.includes(\"gratis\") || lower === \"free\")\r\n        return { value: 0, label: \"Grátis\" };\r\n\r\n    const match = price.match(/(\\d+[\\.,]?\\d*)/);\r\n    if (match) {\r\n        const num = parseFloat(match[1].replace(\",\", \".\"));\r\n        return { value: num, label: `${num}€` };\r\n    }\r\n\r\n    return { value: Infinity, label: price || \"Preço indisponível\" };\r\n}\r\n\r\nfunction isUpcoming(event: Event): boolean {\r\n    const today = new Date();\r\n    today.setHours(0, 0, 0, 0);\r\n    const endOrStart = event.endDate ? new Date(event.endDate) : new Date(event.date);\r\n    return endOrStart >= today;\r\n}\r\n\r\nfunction dedupeEvents(events: Event[]): Event[] {\r\n    const seen = new Set<string>();\r\n    const result: Event[] = [];\r\n\r\n    for (const ev of events) {\r\n        const key = (ev.url || \"\") || `${ev.title}-${ev.date}`;\r\n        const altKey = `${ev.title}-${ev.date}`;\r\n        if (seen.has(key) || seen.has(altKey)) continue;\r\n        seen.add(key);\r\n        seen.add(altKey);\r\n        result.push(ev);\r\n    }\r\n\r\n    return result;\r\n}\r\n\r\nfunction detectCategory(event: Event): EventCategory {\r\n    const text = `${event.title} ${event.description || \"\"} ${event.location || \"\"}`.toLowerCase();\r\n\r\n    if (/(discoteca|nightclub|boate|dj|cabaret|burlesque|stand-up|comedy|vida nocturna|noite)/i.test(text))\r\n        return \"Discoteca/Nightlife\";\r\n    if (/(teatro|peça|espetáculo|dramático)/i.test(text)) return \"Teatro\";\r\n    if (/(cinema|filme|documentário|projeção)/i.test(text)) return \"Cinema\";\r\n    if (/(concerto|música|show|festival|banda|artista|fado|rock|jazz)/i.test(text)) return \"Música\";\r\n    if (/(dança|ballet|coreograf|movimento)/i.test(text)) return \"Dança\";\r\n    if (/(exposição|mostra|galeria|arte|museu|obra)/i.test(text)) return \"Exposição\";\r\n    if (/(palestra|seminário|conferência|talk|workshop|formação|entrevista)/i.test(text)) return \"Conferência\";\r\n    if (/(mercado|feira|market|feria|vendas)/i.test(text)) return \"Mercado/Feira\";\r\n    if (/(festa|party|carnaval|celebração)/i.test(text)) return \"Festa\";\r\n    if (/(ao ar livre|parque|jardim|outdoor)/i.test(text)) return \"Ao Ar Livre\";\r\n    return \"Outro\";\r\n}\r\n\r\nfunction detectMusicGenre(event: Event, category: EventCategory): MusicGenre | undefined {\r\n    if (category !== \"Música\") return undefined;\r\n\r\n    const text = `${event.title} ${event.description || \"\"}`.toLowerCase();\r\n    if (text.includes(\"fado\")) return \"Fado\";\r\n    if (text.includes(\"rock\")) return \"Rock\";\r\n    if (text.includes(\"jazz\")) return \"Jazz\";\r\n    if (text.includes(\"pop\")) return \"Pop\";\r\n    if (text.includes(\"hard techno\") || text.includes(\"hardtechno\")) return \"Hard Techno\";\r\n    if (text.includes(\"techno\")) return \"Techno\";\r\n    if (text.includes(\"trance\")) return \"Trance\";\r\n    if (text.includes(\"house\")) return \"House\";\r\n    if (text.includes(\"funk\")) return \"Funk\";\r\n    if (/(clássic|orquest|sinfonia|clásico)/i.test(text)) return \"Clássico\";\r\n    if (text.includes(\"reggae\")) return \"Reggae\";\r\n    if (/(hip-hop|hiphop|rap)/i.test(text)) return \"Hip-Hop\";\r\n    if (/(folk|tradicion|gaita)/i.test(text)) return \"Folk/Tradicional\";\r\n    if (/(samba|carnaval|bossa nova)/i.test(text)) return \"Samba/Carnaval\";\r\n    if (text.includes(\"k-pop\") || text.includes(\"kpop\")) return \"K-Pop\";\r\n    if (/(experimental|avant-garde)/i.test(text)) return \"Experimental\";\r\n    return undefined;\r\n}\r\n"],"names":[],"mappings":"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"}}]
}